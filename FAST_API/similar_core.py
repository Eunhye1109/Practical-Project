# similar.py  (ìŠ¬ë¦¼ êµì²´ë³¸)
import re
from typing import List, Dict, Tuple

# =========================
# ğŸ§± Top100 í•˜ë“œì½”ë”© (í›„ë³´ í’€)
# =========================
TOP100: List[Tuple[str, str]] = [
    ("005930","ì‚¼ì„±ì „ì"), ("000660","SKí•˜ì´ë‹‰ìŠ¤"), ("373220","LGì—ë„ˆì§€ì†”ë£¨ì…˜"),
    ("207940","ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤"), ("005380","í˜„ëŒ€ì°¨"), ("000270","ê¸°ì•„"),
    ("051910","LGí™”í•™"), ("068270","ì…€íŠ¸ë¦¬ì˜¨"), ("006400","ì‚¼ì„±SDI"),
    ("035420","NAVER"), ("035720","ì¹´ì¹´ì˜¤"), ("028260","ì‚¼ì„±ë¬¼ì‚°"),
    ("066570","LGì „ì"), ("003550","LG"), ("005490","POSCOí™€ë”©ìŠ¤"),
    ("012330","í˜„ëŒ€ëª¨ë¹„ìŠ¤"), ("051900","LGìƒí™œê±´ê°•"), ("055550","ì‹ í•œì§€ì£¼"),
    ("105560","KBê¸ˆìœµ"), ("034730","SK"), ("259960","í¬ë˜í”„í†¤"),
    ("096770","SKì´ë…¸ë² ì´ì…˜"), ("010950","S-Oil"), ("003670","í¬ìŠ¤ì½”ì¼€ë¯¸ì¹¼"),
    ("011200","HMM"), ("000810","ì‚¼ì„±í™”ì¬"), ("086790","í•˜ë‚˜ê¸ˆìœµì§€ì£¼"),
    ("316140","ìš°ë¦¬ê¸ˆìœµì§€ì£¼"), ("086520","ì—ì½”í”„ë¡œ"), ("066970","ì—˜ì•¤ì—í”„"),
    ("011170","ë¡¯ë°ì¼€ë¯¸ì¹¼"), ("010130","ê³ ë ¤ì•„ì—°"), ("251270","ë„·ë§ˆë¸”"),
    ("035510","ì‹ ì„¸ê³„"), ("034020","ë‘ì‚°ì—ë„ˆë¹Œë¦¬í‹°"), ("006800","ë¯¸ë˜ì—ì…‹ì¦ê¶Œ"),
    ("005940","NHíˆ¬ìì¦ê¶Œ"), ("326030","SKë°”ì´ì˜¤íŒœ"), ("018260","ì‚¼ì„±ì—ìŠ¤ë””ì—ìŠ¤"),
    ("032830","ì‚¼ì„±ìƒëª…"), ("180640","í•œì§„ì¹¼"), ("003490","ëŒ€í•œí•­ê³µ"),
    ("272210","í•œí™”ì‹œìŠ¤í…œ"), ("047810","í•œêµ­í•­ê³µìš°ì£¼"),
    ("017670","SKí…”ë ˆì½¤"), ("030200","KT"), ("035600","KGì´ë‹ˆì‹œìŠ¤"),
    ("069620","ëŒ€ì›…ì œì•½"), ("128940","í•œë¯¸ì•½í’ˆ"), ("000720","í˜„ëŒ€ê±´ì„¤"),
    ("006360","GSê±´ì„¤"), ("161390","í•œêµ­íƒ€ì´ì–´ì•¤í…Œí¬ë†€ë¡œì§€"), ("033780","KT&G"),
    ("139480","ì´ë§ˆíŠ¸"), ("204320","ë§Œë„"), ("267250","HDí˜„ëŒ€"),
    ("010620","HDí˜„ëŒ€ì¼ë ‰íŠ¸ë¦­"), ("009540","í•œêµ­ì¡°ì„ í•´ì–‘"), ("009150","ì‚¼ì„±ì „ê¸°"),
    ("000990","DBí•˜ì´í…"), ("021240","ì½”ì›¨ì´"), ("002790","ì•„ëª¨ë ˆG"),
    ("090430","ì•„ëª¨ë ˆí¼ì‹œí”½"), ("028050","ì‚¼ì„±ì—”ì§€ë‹ˆì–´ë§"), ("024110","ê¸°ì—…ì€í–‰"),
    ("003410","ìŒìš©C&E"), ("032640","LGìœ í”ŒëŸ¬ìŠ¤"),
    ("011780","ê¸ˆí˜¸ì„ìœ í™”í•™"), ("017800","í˜„ëŒ€ì—˜ë¦¬ë² ì´í„°"), ("006650","ëŒ€í•œìœ í™”"),
    ("011070","LGì´ë…¸í…"), ("093370","í›„ì„±")
    # í•„ìš” ì‹œ ë” ì±„ì›Œ ë„£ì–´ë„ OK
]

# =========================
# ğŸ”¤ ìœ ì‚¬ë„ ì½”ì–´ (bigrams + Jaccard)
# =========================
def _norm(s: str) -> str:
    if not s: return ""
    s = s.strip().lower()
    return re.sub(r"[^0-9a-zê°€-í£]", "", s)

def _bigrams(s: str) -> set:
    if len(s) < 2:
        return {s} if s else set()
    return {s[i:i+2] for i in range(len(s)-1)}

def _jaccard(a: str, b: str) -> float:
    A, B = _bigrams(_norm(a)), _bigrams(_norm(b))
    if not A and not B: return 1.0
    if not A or not B:  return 0.0
    inter = len(A & B); union = len(A | B)
    return inter / union if union else 0.0

def score_topk_from_top100(base: str, topk: int = 3) -> List[Dict]:
    names = [nm for _, nm in TOP100]
    seen = set()
    scored: List[Dict] = []
    for nm in names:
        if not nm or nm in seen: 
            continue
        seen.add(nm)
        sim = round(_jaccard(base, nm) * 100.0, 1)
        scored.append({
            "name": nm,
            "similarity": sim,
            "reason": "ë¬¸ì bigram ìœ ì‚¬ë„ ê¸°ë°˜"
        })
    scored.sort(key=lambda x: x["similarity"], reverse=True)
    return scored[: max(1, topk)]
